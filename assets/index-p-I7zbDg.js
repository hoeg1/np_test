var Q=Object.defineProperty;var ee=(n,e,t)=>e in n?Q(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var u=(n,e,t)=>ee(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();const m=511,R=0,U=1,te=2,v=n=>{const e=Math.trunc(n/36e5),t=Math.trunc((n-e*36e5)/6e4),s=Math.trunc((n-e*36e5-t*6e4)/1e3);return(e>0?e.toString()+":":"")+t.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")},W=(n,e)=>{const t=n%9,s=Math.trunc(n/9),r=s*9,i=t-t%3,a=s-s%3,o=i+a*9;for(let c=0,d=0;c<9;++c){const _=r+c;if(_!=n&&!e(_,R))return!1;const h=t+c*9;if(h!=n&&!e(h,U))return!1;const f=c%3,y=o+d+f;if(y!=n&&!e(y,te))return!1;f==2&&(d+=9)}return!0},g=n=>n!=0&&(n&-n)==n,b=()=>new Array(81).fill(m),w=(n,e,t,s)=>{n[e]=t;const r=~t;return W(e,(i,a)=>n[i]&t?(n[i]&=r,s&&g(n[i])?(w(n,i,n[i],!0),!0):n[i]!=0):!0)},F=()=>Math.trunc(Math.random()*268435455),C=n=>{let e=!0;for(;e;){e=!1;let t=0;for(let s=0;s<81;++s){const r=n[s];if(r==0)return!1;if(g(r)){if(t+=1,t==81)return!0;continue}let i=0,a=0,o=0;W(s,(h,f)=>{switch(f){case R:i|=n[h];break;case U:a|=n[h];break;default:o|=n[h];break}return!0});const c=(i^r)&r,d=(a^r)&r,_=(o^r)&r;if(g(c)){if(!w(n,s,c,!0))return!1;e=!0}else if(g(d)){if(!w(n,s,d,!0))return!1;e=!0}else if(g(_)){if(!w(n,s,_,!0))return!1;e=!0}}}return!1},K=n=>{const e=b();for(let t=0;t<81;++t)if(n[t]!=m&&!w(e,t,n[t],!0))return!1;return C(e)},E=n=>{switch(n){case 1:return 1;case 2:return 2;case 4:return 3;case 8:return 4;case 16:return 5;case 32:return 6;case 64:return 7;case 128:return 8;case 256:return 9;case 511:return 0;default:throw new Error(`bit_to_num - panic! arg: 'bit'=${n}`)}},p=class p{constructor(e){u(this,"rand_x");u(this,"rand_y");u(this,"rand_z");u(this,"rand_w");u(this,"seed");this.rand_x=531829021,this.rand_y=291032475,this.rand_z=771890231,this.rand_w=e,this.seed=e}async gen_np(){return await new Promise(e=>{const t=this.create_quest();e(t)})}gen_now(){return this.create_quest()}next_int(){const e=this.rand_x^this.rand_x<<11,t=this.rand_w;return this.rand_x=this.rand_y,this.rand_y=this.rand_z,this.rand_z=t,this.rand_w=t^t>>>19^(e^e>>>8)}random(e){return Math.abs(this.next_int())%e}shuffle(e){let t=e.length;for(;t>0;){const s=this.random(t--);[e[t],e[s]]=[e[s],e[t]]}return e}create_ans(){const e=this.put_ans(b(),0);if(e.length!=0)return e;throw new Error("解答作りに失敗")}put_ans(e,t){if(t>=81){for(let i=0;i<81;++i)if(!g(e[i]))throw new Error("ng");return e}const s=e[t];if(s==0)return[];if(g(s))return this.put_ans(e,t+1);const r=this.shuffle([1,2,4,8,16,32,64,128,256]);for(const i of r)if(i&s){const a=[...e];if(w(a,t,i,!0)){if(C(a))return a;const o=this.put_ans(a,t+1);if(o.length!=0)return o}}return[]}get_taisho(e,t){const s=e%9,r=Math.trunc(e/9);switch(t){case p.CENTER:return 8-s+(8-r)*9;case p.JOGE:{const i=s+(8-r)*9;return i==e?8-s+r*9:i}case p.SAYU:{const i=8-s+r*9;return i==e?s+(8-r)*9:i}case p.GKESA:return s==r?(s+8)%8+(r+8)%8*9:r+s*9;default:return s+r==8?r+s*9:(s+8)%8+(r+8)%8*9}}open_duo(e,t,s,r,i){for(;i>0;){const a=this.random(81);if(!g(e[a])){const o=this.get_taisho(a,r);if(t[o]==m){if(t[a]=s[a],w(e,a,s[a],!0),C(e)||a!=o&&(t[o]=s[o],!g(e[o])&&(w(e,o,s[o],!0),C(e))))return!1;i-=1}}}return!0}get_pos_list(e){const t=[];for(let s=0;s<81;++s)e[s]!=m&&t.push(s);return this.shuffle(t)}slim(e,t=[],s=this.get_pos_list(e)){let r=[...t];for(const i of s){if(t.includes(i))continue;const a=b();for(const o of s)o!=i&&!t.includes(o)&&w(a,o,e[o],!0);if(C(a)){const o=[...t];o.push(i);const c=this.slim(e,o,s);if(c.length>r.length)return c;o.length>r.length&&(r=o)}}return r}translate(e){const t=[];for(let i=1;i<=9;++i)t.push({from:i,to:0,count:0});const s=[];for(let i=0;i<81;++i){const a=e.que[i];if(g(a)){const o=E(a)-1;t[o].count+=1,s.push(i)}}t.sort((i,a)=>i.count==a.count?0:i.count>a.count?-1:1);for(let i=0;i<9;++i)t[i].to=1<<i;t.sort((i,a)=>i.from==a.from?0:i.from<a.from?-1:1);const r={que:b(),ans:b(),hint:e.hint,seed:this.seed};for(const i of s){const a=E(e.que[i]);r.que[i]=t[a-1].to}for(let i=0;i<81;++i){const a=E(e.ans[i]);r.ans[i]=t[a-1].to}return r}create_quest(){const e=this.create_ans(),t=b(),s=b(),r=this.random(p.TYPE_MAX);for(this.open_duo(t,s,e,r,7);this.open_duo(t,s,e,r,1););const i=this.slim(s);if(i.length){const a=b();let o=0;for(let c=0;c<81;++c)i.includes(c)||(a[c]=s[c],s[c]!=m&&(o+=1));if(K(a))return this.translate({que:a,ans:e,hint:o,seed:this.seed});throw new Error("解けない問題を出力(1): "+this.seed)}else{let a=0;for(let o=0;o<81;++o)s[o]!=m&&(a+=1);if(K(s))return this.translate({que:s,ans:e,hint:a,seed:this.seed});throw new Error("解けない問題を出力(2): "+this.seed)}}};u(p,"CENTER",0),u(p,"JOGE",1),u(p,"SAYU",2),u(p,"GKESA",3),u(p,"KESA",4),u(p,"TYPE_MAX",5);let O=p;class A{constructor(){u(this,"start_time");u(this,"te_cnt");u(this,"game_state","Wait");u(this,"time_restore",0);u(this,"total_time",0);u(this,"pause_time",0);u(this,"pause_sum",0);u(this,"hint_time",new Date);u(this,"has_next",!1);u(this,"cur_game",{ans:[],que:[],hint:0,seed:0});u(this,"next_game",{ans:[],que:[],hint:0,seed:0});u(this,"ply",[]);u(this,"his",[]);u(this,"bscore",0);u(this,"final_score",0);u(this,"bunpai",[]);u(this,"tmp_ply",[]);u(this,"num_count",[]);u(this,"clear_day",new Date);u(this,"is_daily",!1);this.start_time=new Date,this.te_cnt=81}init(e=F(),t=!1){this.is_daily=t,new O(e).gen_np().then(s=>{this.cur_game=s,this.ply=[...s.que],this.his=[],this.calc_bunpai(),this.calc_tmp(),this.game_state="Not Started",this.make_next()})}from_game_id(e){this.game_state="Wait",new O(e.seed).gen_np().then(t=>{this.cur_game=t,this.ply=[...t.que],this.his=[],this.calc_bunpai(),this.calc_tmp(),this.game_state="Not Started",this.make_next()})}from_savedata(e){this.time_restore=e.time,this.pause_sum=0,this.ply=e.ply,this.cur_game=e.cur_game,this.his=e.his,this.te_cnt=e.te,this.calc_bunpai(),this.calc_tmp(),this.game_state="Not Started",this.make_next()}new_game(){return this.has_next?(this.cur_game=this.next_game,this.ply=[...this.cur_game.que],this.te_cnt=81,this.bscore=0,this.final_score=0,this.his=[],this.num_count=[],this.pause_sum=0,this.time_restore=0,this.calc_bunpai(),this.calc_tmp(),this.game_state="Not Started",this.make_next(),!0):!1}make_next(){this.has_next=!1,new O(F()).gen_np().then(e=>{this.next_game=e,this.has_next=!0})}get_savedata(){const e=new Date;return{saved_time:e,time:this.calc_time(e.getTime()),cur_game:JSON.parse(JSON.stringify(this.cur_game)),ply:[...this.ply],his:JSON.parse(JSON.stringify(this.his)),te:this.te_cnt}}calc_time(e=Date.now()){return e-this.start_time.getTime()-this.pause_sum+this.time_restore}now_time_str(){return this.game_state=="Wait"?"":this.game_state=="Clear"?v(this.total_time):this.game_state=="Start"?v(this.calc_time()):this.game_state=="Pause"?v(this.calc_time(this.pause_time)):"00:00"}game_start(){this.game_state=="Not Started"?(this.start_time=new Date,this.hint_time=new Date,this.game_state="Start"):this.game_state=="Pause"&&(this.pause_sum+=Date.now()-this.pause_time,this.game_state="Start")}game_pause(){this.game_state=="Start"&&(this.pause_time=Date.now(),this.game_state="Pause")}get seed_str(){return this.game_state!="Wait"?"0x"+this.cur_game.seed.toString(16).toUpperCase():"[no seed]"}get cur_seed(){return this.game_state!="Wait"?this.cur_game.seed:-1}get state(){return this.game_state}has_next_game(){return this.has_next}get te_count(){return this.te_cnt}calc_rank_medal(e=this.final_score){return e>=2e5?[7,"Ⓝ"]:e>=19e4?[6,"Ⓢ"]:e>=18e4?[5,"Ⓐ"]:e>=17e4?[4,"Ⓑ"]:e>=16e4?[3,"Ⓒ"]:e>=15e4?[2,"Ⓓ"]:e>=14e4?[1,"Ⓔ"]:[0,"Ⓕ"]}encode_game(e,t,s){const r="0",i=[["X","y","z"],["x","z","y"],["Y","x","z"],["y","z","x"],["Z","x","y"],["z","y","x"]],a=["g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W"],o=e.toString(16),c=t.toString(16),d=s.toString(16),_=i[Math.trunc(Math.random()*i.length)];let h=r+_[0];for(const f of _){const y=a[Math.trunc(Math.random()*a.length)];f=="x"||f=="X"?h+=(Math.random()<.5?o:o.toUpperCase())+y:f=="y"||f=="Y"?h+=(Math.random()<.5?c:c.toUpperCase())+y:h+=(Math.random()<.5?d:d.toUpperCase())+y}return h}decode_game(e){const t=/^0([xyzXYZ])([0-9a-fA-F]+)[g-wG-W]([0-9a-fA-F]+)[g-wG-W]([0-9a-fA-F]+)[g-wG-W]$/,s=e.trim();if(t.test(s)){const r=t.exec(s),i=r[1],a=parseInt(r[2],16),o=parseInt(r[3],16),c=parseInt(r[4],16);return i=="X"?{seed:a,time_ms:o,score:c}:i=="x"?{seed:a,time_ms:c,score:o}:i=="Y"?{seed:o,time_ms:a,score:c}:i=="y"?{seed:o,time_ms:c,score:a}:i=="Z"?{seed:c,time_ms:a,score:o}:{seed:c,time_ms:o,score:a}}else return}get_game_score(){if(this.game_state=="Clear"){const e=this.get_time_minus(this.total_time);return{uid:-1,seed:this.cur_game.seed,is_daily:this.is_daily,hint:this.cur_game.hint,day:this.clear_day,score:this.final_score,medal:this.calc_rank_medal(),base:this.bscore,time_ms:this.total_time,time_str:v(this.total_time),time_minus:Math.round(e),bonus:this.get_bonus(this.bscore,e),game_id:this.encode_game(this.cur_game.seed,this.total_time,this.final_score)}}else return null}get_his_list(){return{seed:this.cur_game.seed,ans:[...this.cur_game.ans],que:[...this.cur_game.que],kihu:[...this.his]}}que_at(e){return this.cur_game.que[e]}ans_at(e){return this.cur_game.ans[e]}ply_at(e){return this.ply[e]}tmp_at(e){return this.tmp_ply[e]}get_num_base_point(e){if(this.game_state=="Start"&&e>0&&e<10){const t=this.bunpai[e];return Math.round(this.te_cnt*(t*(t+1)/2))}else return-1}is_discovered(e){return this.game_state=="Start"&&e>0&&e<10?this.num_count[e]==9:!1}calc_bunpai(){const e=new Array(10).fill(0);for(let t=0;t<81;++t){const s=this.que_at(t);if(s!=m){const r=E(s);e[r]+=1}}this.bunpai=new Array(10).fill(0);for(let t=1;t<10;++t)e[t]!=9&&(this.bunpai[t]=t+t*e[t]/(9-e[t]))}calc_base_point(){const e=new Array(81).fill(!1);let t=0;for(let s=this.his.length-1;s>=0;--s){const r=this.his[s].pos,i=this.his[s].bit;if(i!=m&&!e[r]){if(this.ans_at(r)!=i)throw new Error("最初に見つかるのは答えのはず");e[r]=!0;const a=this.bunpai[E(i)],o=a*(a+1)/2;t+=o*this.his[s].cnt}}for(let s=1;s<10;++s)if(this.bunpai[s]==0){const r=s*(s+1)/2;t+=r*this.te_cnt*9}return Math.round(t)}play_number(e,t){if(this.game_state!="Start"||this.que_at(e)!=m)throw new Error(`state=${this.game_state}, que[${e}]=${this.que_at(e)}`);if(t!=0){const s=1<<t-1;this.his.push({cnt:this.te_cnt,pos:e,bit:s,old:this.ply[e]}),this.te_cnt>1&&(this.te_cnt-=1),this.ply[e]=s}else this.his.push({cnt:0,pos:e,bit:m,old:this.ply[e]}),this.ply[e]=m;return this.calc_tmp()}get_time_minus(e){return e/10}get_bonus(e,t){return Math.round(Math.max(0,e-t))}calc_tmp(){const e=b();this.num_count=new Array(10).fill(0);let t=!1,s=0;for(let r=0;r<81;++r)if(this.ans_at(r)==this.ply[r]&&(s+=1),this.ply[r]!=m){const i=E(this.ply[r]);this.num_count[i]+=1,w(e,r,this.ply[r],!1)||(t=!0)}return s==81?(this.clear_day=new Date,this.total_time=this.calc_time(this.clear_day.getTime()),this.game_state="Clear",this.bscore=this.calc_base_point(),this.final_score=this.bscore+this.get_bonus(this.bscore,this.get_time_minus(this.total_time)),!1):(this.tmp_ply=e,t)}is_legal(e,t){if(this.game_state=="Start"){if(t==0)return this.ply[e]!=m&&this.que_at(e)==m;{const s=1<<t-1;return(this.tmp_at(e)&s)!=0}}else return!1}can_hint(){return Date.now()-this.hint_time.getTime()>6e4&&this.game_state==="Start"}get_err_list(){const e=[];for(let t=0;t<81;++t)this.ply_at(t)!=m&&this.ply_at(t)!=this.ans_at(t)&&e.push(t);return e}get_hint(e){if(!this.can_hint()||this.game_state!="Start")throw new Error("no hint error");{const t=this.get_err_list();if(t.length!=0)return this.hint_time=new Date,t;if(e)return null;const s=[];for(let r=0;r<10;++r)s.push(new Set);for(let r=0;r<81;++r)if(this.ply_at(r)==m){const i=this.tmp_at(r);if(g(i))s[E(i)].add(r);else{let a=0,o=0,c=0;W(r,(f,y)=>{switch(y){case R:a|=this.tmp_ply[f];break;case U:o|=this.tmp_ply[f];break;default:c|=this.tmp_ply[f];break}return!0});const d=(a^i)&i,_=(o^i)&i,h=(c^i)&i;g(d)?s[E(d)].add(r):g(_)?s[E(_)].add(r):g(h)&&s[E(h)].add(r)}}for(let r=1;r<10;++r)if(s[r].size!=0){const i=[...s[r]],a=Math.trunc(Math.random()*i.length);return this.hint_time=new Date,[i[a]]}return null}}}const Z=new Intl.DateTimeFormat,se=new Intl.PluralRules("en-US",{type:"ordinal"}),ne=new Map([["one","st"],["two","nd"],["few","rd"],["other","th"]]),re=n=>{const e=se.select(n),t=ne.get(e);return`${n}${t}`},q="high_score_v011",X="high_score_v0",J="user_setting_v0";let l=null,S=9,L=!1,B=[],N=!1,x=null;const z=[],V=n=>{const e=T();for(const t of e)if(t.seed==n)return!0;return!1},P=(n=!1)=>{const e={outer:"#000000",middle:"#808080",inner:"#a9a9a9",use_dash:!0,fg:"#ffffff",bg:"#f8f8f8",use_chk:!0,hint:"#831100",err:"#ff0000",num:"#000000",hnum:"#000000",alpha:255};if(!n&&localStorage.hasOwnProperty(J)){const t=JSON.parse(localStorage.getItem(J));return{outer:t.outer??e.outer,middle:t.middle??e.middle,inner:t.inner??e.inner,use_dash:t.use_dash??e.use_dash,fg:t.fg??e.fg,bg:t.bg??e.bg,use_chk:t.use_chk??e.use_chk,hint:t.hint??e.hint,err:t.err??e.err,num:t.num??e.num,hnum:t.hnum??e.hnum,alpha:t.alpha??e.alpha}}else return e},H=n=>{const e=document.querySelector(":root");e.style.setProperty("--outer-border-color",n.outer),e.style.setProperty("--middle-border-color",n.middle),e.style.setProperty("--cell-border-color",n.inner),e.style.setProperty("--cell-border-style",n.use_dash?"dashed":"solid"),e.style.setProperty("--puz-bg-color",n.use_chk?n.bg:n.fg),e.style.setProperty("--cell-fg-color",n.fg),e.style.setProperty("--cell-color",n.num),e.style.setProperty("--cell-hint-color",n.hnum);const t=parseInt(n.alpha).toString(16).padStart(2,0);e.style.setProperty("--cell-sphint-color",n.hint+t),e.style.setProperty("--cell-err-color",n.err)},ie=()=>{const n=P(),e=[["outer",n.outer],["middle",n.middle],["inner",n.inner],["use_dash",n.use_dash],["fg",n.fg],["bg",n.bg],["use_chk",n.use_chk],["num",n.num],["hnum",n.hnum],["hint",n.hint],["err",n.err],["alpha",n.alpha]];e.forEach(t=>{const s=`s_${t[0]}`,r=document.getElementById(s);t[0]!="use_dash"&&t[0]!="use_chk"?r.value=t[1]:r.checked=t[1]}),document.getElementById("setting_cur_alpha").innerText=n.alpha,document.getElementById("set-def").addEventListener("click",()=>{const t=P(!0);e.forEach(s=>{s[0]!="use_dash"&&s[0]!="use_chk"?document.getElementById(`s_${s[0]}`).value=t[s[0]]:document.getElementById(`s_${s[0]}`).checked=t[s[0]]}),document.getElementById("setting_cur_alpha").innerText=t.alpha}),document.getElementById("s_close").addEventListener("click",t=>{t.preventDefault();const s=P(!0);e.forEach(r=>{r[0]==="alpha"?s[r[0]]=parseInt(document.getElementById(`s_${r[0]}`).value):r[0]!="use_dash"&&r[0]!="use_chk"?s[r[0]]=document.getElementById(`s_${r[0]}`).value:s[r[0]]=document.getElementById(`s_${r[0]}`).checked}),H(s),localStorage.setItem(J,JSON.stringify(s)),document.getElementById("settings_dialog").close()})},T=()=>localStorage.hasOwnProperty(q)?JSON.parse(localStorage.getItem(q)):[],D=()=>{l.state==="Wait"||l.state==="Not Started"?k("press Start or Nyanplé"):l.state==="Clear"?k("Congratulations!"):k(N?"resigned...":`${l.get_num_base_point(S).toLocaleString()}pt (${l.te_count})`)},ae=()=>{const n=document.getElementById("tools"),e=n.cloneNode(!0),t=e.querySelectorAll("button");for(const s of t)s.dataset.sel=!1,s.dataset.all=!0;n.parentNode.replaceChild(e,n)},oe=()=>{S=9;const n=document.getElementById("tools"),e=n.cloneNode(!0),t=e.querySelectorAll("button");for(const s of t)s.addEventListener("click",()=>{j(s.dataset.id)}),s.dataset.sel=s.dataset.id==S,s.dataset.all=!1,s.dataset.id==-1&&s.classList.remove("tool-hint");n.parentNode.replaceChild(e,n)},j=n=>{if(!(l.state!="Start"||N||n!=-1&&n==S)){if(n!=-1){S=n;const e=document.getElementById("tools"),t=e.cloneNode(!0),s=t.querySelectorAll("button");for(const r of s)r.addEventListener("click",()=>{j(r.dataset.id)}),r.dataset.id!=-1&&(r.dataset.id!=n?(r.dataset.sel="false",r.dataset.all=l.is_discovered(r.dataset.id)):r.dataset.sel="true");e.parentNode.replaceChild(t,e),D()}else{if(!l.can_hint())return;const e=l.get_hint(L);e!=null?(B=e,document.getElementById("tool_hint").classList.remove("tool-hint"),I()):k("Sorry, No Hints Found :(")}I()}},le=()=>{const n=document.getElementById("tools").querySelectorAll("button");for(const e of n)e.dataset.all=!1,e.addEventListener("click",()=>{j(e.dataset.id)})},$=n=>{const e=E(n);return e==0?"":e},k=n=>{document.getElementById("mes").innerText=n},I=()=>{const n=document.getElementById("cell_grid"),e=n.cloneNode(!0);let t=0;for(const s of e.querySelectorAll("td"))l.state!="Start"&&l.state!="Clear"?(s.dataset.num=N?$(l.ans_at(t)):"",s.dataset.type=""):l.que_at(t)!=m?(s.dataset.num=$(l.que_at(t)),s.dataset.type="hint"):(l.ply_at(t)!=m?(s.dataset.num=$(l.ply_at(t)),L&&B.includes(t)?s.dataset.type="err":s.dataset.type=""):(s.dataset.num="",!L&&B.includes(t)?(s.dataset.type="sphint",s.dataset.num=$(l.ans_at(t))):l.is_legal(t,S)?s.dataset.type="":s.dataset.type="check"),s.dataset.id=t,l.state!="Clear"&&s.addEventListener("click",r=>{const i=r.target.dataset.id;l.ans_at(i)!=l.ply_at(i)&&S!=$(l.ply_at(i))&&(L=l.play_number(i,S),L?B.includes(i)&&B.splice(i,1):B=[],l.is_discovered(S)&&(document.getElementById("tools").querySelector(`[data-id="${S}"]`).dataset.all=!0),D(),I(),l.state==="Clear"&&(document.getElementById("start").innerText="New Game",ae(),ce()))})),t+=1;n.parentNode.replaceChild(e,n)},ce=()=>{if(l.state!="Clear")return;const n=l.get_game_score(),e=T();n.uid=e.length,e.push(n),e.sort((r,i)=>r.score==i.score?i-r:i.score-r.score),localStorage.setItem(q,JSON.stringify(e)),z.push(n);let t=1;for(let r=0;r<e.length;++r)if(e[r].uid==n.uid){t=r+1;break}k(`${n.medal[1]} ${n.score.toLocaleString()}pt`);const s=document.getElementById("cong_dialog");s.querySelector("#share-url").innerText=n.game_id,s.querySelector(".medal").innerText=n.medal[1],s.querySelector("#final_score").innerText=`${n.score.toLocaleString()}pt`,x!=null?(s.querySelector("#score_nth").innerText=n.score>x.score?"あなたの勝ち！":n.score==x.score?"同点です":"あなたの負け",s.querySelector("#score_base").innerText=` - 目標: ${x.score}`):n.is_daily?(s.querySelector("#score_nth").innerText=Z.format(n.day),s.querySelector("#score_base").innerText=""):(s.querySelector("#score_nth").innerText=re(t),s.querySelector("#score_base").innerText=`/${e.length}`),s.querySelector("#cur_time").innerText=n.time_str,x!=null?s.querySelector("#minus_pt").innerText=`相手: ${v(x.time_ms)}`:s.querySelector("#minus_pt").innerText=`▲${n.time_minus.toLocaleString()}pt`,s.querySelector("#cur_bp").innerText=`${n.base.toLocaleString()}pt`,s.querySelector("#cur_hint").innerText=`(${n.hint} hints)`,s.querySelector("#cur_bonus").innerText=`${n.bonus.toLocaleString()}pt`,s.showModal()},ue=()=>{const n=new Date,e=Number(n.getFullYear().toString().slice(-2))*1e4+n.getMonth()*100+n.getDate();if(V(e)){alert("本日の問題はプレイ済みです。");return}if(l.state=="Start"){if(!confirm(`Are you sure?
現在の問題は消去されます。`))return;l.game_pause()}const t=new A;t.init(e,!0),alert("Daily Quest を始めます！"),l=t,Y(!1)},G=(n,e)=>{const t=document.createElement("table");t.classList.add("score_table");const s=document.createElement("thead"),r=document.createElement("tr");[" ","Score","Time","Base","Date"].forEach(a=>{const o=document.createElement("th");o.innerText=a,r.appendChild(o)}),s.appendChild(r),t.appendChild(s);const i=document.createElement("tbody");return n.forEach((a,o)=>{const c=document.createElement("tr");c.classList.add("score_line"),[["td_medal",a.medal[1]],["td_score",a.score.toLocaleString()],["td_time",a.time_str],["td_base",a.base.toLocaleString()],["td_day",Z.format(new Date(a.day))]].forEach((d,_)=>{const h=document.createElement("td");h.classList.add(d[0]),e&&_==0?h.innerText=`${d[1]} ${o+1}`:h.innerText=d[1],a.is_daily&&d[0]==="td_day"&&h.classList.add("is-daily-game"),d[0]==="td_score"&&(h.dataset.game_id=a.game_id,h.addEventListener("click",f=>{const y=f.currentTarget.dataset.game_id;confirm(`ID: ${y}
をコピーしますか？`)&&(navigator.clipboard.writeText(y),alert("コピーしました"))})),c.appendChild(h)}),i.appendChild(c)}),t.appendChild(i),t},de=n=>{let e=-1,t=0n,s=0n,r=0n;const i=[0,0,0,0,0,0,0,0];for(const d of n)i[d.medal[0]]+=1,e<d.medal[0]&&(e=d.medal[0]),t+=BigInt(d.score),s+=BigInt(d.time_ms),r+=BigInt(d.base);i.forEach((d,_)=>{document.getElementById(`medal-${_}`).innerText=`${d} 個`}),document.getElementById("cur-medal").innerText=["Ⓕ","Ⓔ","Ⓓ","Ⓒ","Ⓑ","Ⓐ","Ⓢ","Ⓝ"][e];const a=BigInt(n.length);document.getElementById("avg-cnt").innerText=`${a} 回`;const o=t/a;document.getElementById("avg-medal").innerText=l.calc_rank_medal(Number(o))[1],document.getElementById("avg-score").innerText=`${o.toLocaleString()}pt`;const c=BigInt(s/a);document.getElementById("avg-time").innerText=`${v(Number(c))}`,document.getElementById("avg-minus").innerText=`▲${(c/10n).toLocaleString()}pt`,document.getElementById("avg-base").innerText=`${(r/a).toLocaleString()}pt`},he=()=>{const n=T();if(n.length>0){const e=document.getElementById("all_cont"),t=e.cloneNode(!1);if(t.appendChild(G(n,!0)),e.parentNode.replaceChild(t,e),de(n),z.length>0){const s=document.getElementById("current_cont"),r=s.cloneNode(!1);r.appendChild(G(z,!1)),s.parentNode.replaceChild(r,s),document.getElementById("current").checked=!0}else document.getElementById("all").checked=!0}document.getElementById("score_dialog").showModal()},Y=(n=!0)=>{n&&(l.new_game(),x=null),N=!1,L=!1,B=[],document.getElementById("time").innerText="00:00",oe(),document.getElementById("start").innerText="Start >",D(),I()},M=()=>{document.getElementById("menu-chk").checked=!1},me=()=>{const n=localStorage.getItem(X);if(n!=null){const t=JSON.parse(n).filter(s=>s.medal[0]!=0);for(let s of t){if(s.medal[0]==0)throw new Error("panic");s.medal[0]-=1,s.medal[1]=["Ⓕ","Ⓔ","Ⓓ","Ⓒ","Ⓑ","Ⓐ","Ⓢ","Ⓝ"][s.medal[0]]}localStorage.removeItem(X),localStorage.setItem(q,JSON.stringify(t))}};(()=>{me(),H(P()),l=new A,l.init(),le(),document.getElementById("menu_high").addEventListener("click",()=>{M(),he()}),document.getElementById("menu_daily").addEventListener("click",()=>{M(),ue()}),document.getElementById("menu_load").addEventListener("click",()=>{if(M(),l.state=="Start"){if(!confirm(`Are you sure?
現在の問題は消去されます。`))return;l.game_pause()}const t=prompt("Game IDを入力してください","-- game id --");if(t!=null&&t!=""){const s=l.decode_game(t);if(s==null)alert("読み込みに失敗しました。");else{if(V(s.seed)){alert(`${t}
はプレイ済みの問題です。`);return}const r=new A;r.from_game_id(s),alert(`ID: ${t}
を始めます。
目標スコア: ${s.score}`),l=r,x=s,Y(!1)}}}),ie(),document.getElementById("menu_setting").addEventListener("click",()=>{M(),document.getElementById("settings_dialog").showModal()}),document.getElementById("menu_how").addEventListener("click",()=>{M(),document.getElementById("how_dialog").showModal()});const n="Pause Ⅱ",e=document.getElementById("pause_dialog");e.addEventListener("close",()=>{e.returnValue==="resign"?(N=!0,document.getElementById("start").innerText="New Game",k("resigned...")):(document.getElementById("start").innerText=n,l.game_start()),I()}),document.getElementById("copy-json").addEventListener("click",()=>{const t=JSON.stringify(T()),s=document.createElement("a");s.download="score.json.txt",s.href=URL.createObjectURL(new Blob([t],{type:"text.plain"})),s.dataset.downloadurl=["text/plain",s.download,s.href].join(":"),s.click()}),T().length>100?document.getElementById("del-100").addEventListener("click",()=>{if(confirm("100位より悪いスコアをすべて消去します")){const t=T(),s=JSON.stringify(t.slice(0,100));localStorage.setItem(q,s),alert(`remove!
消去しました。`)}}):document.getElementById("del-100").disabled=!0,document.getElementById("del-all").addEventListener("click",()=>{confirm("ハイスコアをすべて消去します")&&(localStorage.removeItem(q),alert(`remove!
消去しました。`))}),document.getElementById("te-button").addEventListener("click",()=>{const t=JSON.stringify(l.get_his_list()),s=document.createElement("a");s.download="kihu.json.txt",s.href=URL.createObjectURL(new Blob([t],{type:"text.plain"})),s.dataset.downloadurl=["text/plain",s.download,s.href].join(":"),s.click()}),document.getElementById("share-button").addEventListener("click",()=>{const t=document.getElementById("share-url").innerText;t!=""&&(navigator.clipboard.writeText(t),alert(`${t}
をコピーしました`))}),document.getElementById("resign_button").addEventListener("click",t=>{t.preventDefault(),e.close("resign")}),document.getElementById("close_button").addEventListener("click",t=>{t.preventDefault(),e.close("restart")}),document.getElementById("start").addEventListener("click",()=>{const t=s=>{document.getElementById("start").innerText=s};l.state!=="Wait"&&(N||l.state==="Clear"?Y():l.state==="Not Started"?(l.game_start(),t(n),D(),I()):l.state==="Start"?(l.game_pause(),t("Restart >"),I(),e.showModal()):l.state==="Pause"&&(l.game_start(),t(n),I()))}),setInterval(()=>{const t=document.getElementById("time");t.innerText=l.now_time_str();const s=document.getElementById("tool_hint");!s.classList.contains("tool-hint")&&l.can_hint()&&s.classList.add("tool-hint")},1e3)})();
